# EnvoyFilter to configure the external processor in Istio
#
# This EnvoyFilter adds the customrouter ext_proc to the Istio ingress gateway.
# The ext_proc evaluates CustomHTTPRoute rules and sets headers to control routing.
#
# Prerequisites:
#   1. Deploy the customrouter-external-processor Deployment and Service
#   2. Apply this EnvoyFilter (ext_proc filter)
#   3. Apply envoyfilter-routes.yaml (route injection)
#   4. Create ServiceEntry for each backend service (registers cluster in Envoy)
#
# Usage:
#   kubectl apply -f envoyfilter.yaml
#   kubectl apply -f envoyfilter-routes.yaml
#   kubectl apply -f serviceentry.yaml

apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: customrouter-external-processor
  #namespace: istio-system
  namespace: istio
spec:
  # Select which workloads this filter applies to
  # Change this to match your ingress gateway labels
  workloadSelector:
    labels:
      istio: gateway-production
      #istio: ingressgateway

  configPatches:
    # Add the ext_proc filter to the HTTP filter chain
    # It must be inserted BEFORE the router filter
    - applyTo: HTTP_FILTER
      match:
        context: GATEWAY
        listener:
          filterChain:
            filter:
              name: envoy.filters.network.http_connection_manager
              subFilter:
                name: envoy.filters.http.router
      patch:
        operation: INSERT_BEFORE
        value:
          name: envoy.filters.http.ext_proc
          typed_config:
            "@type": type.googleapis.com/envoy.extensions.filters.http.ext_proc.v3.ExternalProcessor
            grpc_service:
              envoy_grpc:
                # The cluster name follows Istio's naming convention:
                # outbound|<port>||<service>.<namespace>.svc.cluster.local
                cluster_name: outbound|9001||customrouter-external-processor.customrouter.svc.cluster.local
              timeout: 1s
            failure_mode_allow: false
            processing_mode:
              request_header_mode: SEND
              response_header_mode: SKIP
              request_body_mode: NONE
              response_body_mode: NONE
              request_trailer_mode: SKIP
              response_trailer_mode: SKIP
            # CRITICAL: Allow modification of routing headers
            # Without this, the ext_proc cannot change the destination
            mutation_rules:
              allow_all_routing: true
              allow_envoy: false
              # Allow our custom header for cluster selection
              allow_expression:
                - safe_regex:
                    regex: "x-customrouter-.*"
