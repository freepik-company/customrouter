apiVersion: customrouter.freepik.com/v1alpha1
kind: CustomHTTPRoute
metadata:
  labels:
    app.kubernetes.io/name: customrouter
    app.kubernetes.io/managed-by: kustomize
  name: example-routes
spec:
  # Target identifies which external processor will handle these routes
  # The external processor should be started with --target-name=default
  targetRef:
    name: default

  hostnames:
    - www.example.com
    - example.com

  # Path prefixes (languages, regions, etc.)
  # Automatically prepended to the paths defined in the rules
  pathPrefixes:
    values: [es, fr, it, de, pt, ja, ko]
    policy: Optional  # Optional | Required | Disabled
    # expandMatchTypes controls which match types are expanded with path prefixes.
    # When omitted, all types are expanded. Example: only expand PathPrefix and Exact:
    # expandMatchTypes: [PathPrefix, Exact]

  # catchAllRoute (optional) configures automatic generation of catch-all virtual hosts
  # for this route's hostnames. When specified, the operator generates an EnvoyFilter that
  # creates default routes, allowing CustomHTTPRoute to handle requests without requiring
  # a base HTTPRoute to be configured separately.
  #
  # The hostnames are taken from spec.hostnames above.
  catchAllRoute:
    backendRef:
      name: default
      namespace: web
      port: 80

  rules:
    # ====================
    # BASIC ROUTING
    # ====================

    # Simple PathPrefix match (default, fastest)
    - matches:
        - path: /calendar/halloween
        - path: /collection
      backendRefs:
        - name: web-en
          namespace: web
          port: 80

    # Exact match with high priority
    - matches:
        - path: /health
          type: Exact
          priority: 2000
      backendRefs:
        - name: health
          namespace: infra
          port: 8080
      pathPrefixes:
        policy: Disabled

    # Exact match with expandMatchTypes override at rule level
    # This rule only expands PathPrefix matches; Exact matches stay literal
    - matches:
        - path: /user/me
          type: Exact
        - path: /user
      backendRefs:
        - name: users-api
          namespace: backend
          port: 8080
      pathPrefixes:
        policy: Optional
        expandMatchTypes: [PathPrefix]

    # Regex match (Go regexp syntax)
    - matches:
        - path: ^/users/[0-9]+/profile$
          type: Regex
          priority: 1500
      backendRefs:
        - name: users-api
          namespace: backend
          port: 8080
      pathPrefixes:
        policy: Disabled

    # ====================
    # REDIRECTS (SEO, migrations)
    # ====================
    # Note: backendRefs is not required for redirect rules

    # Permanent redirect (301) - old URL to new URL
    - matches:
        - path: /old-page
          type: Exact
          priority: 2000
      actions:
        - type: redirect
          redirect:
            path: /new-page
            statusCode: 301
      pathPrefixes:
        policy: Disabled

    # Redirect HTTP to HTTPS
    - matches:
        - path: /secure
          priority: 1800
      actions:
        - type: redirect
          redirect:
            scheme: https
            statusCode: 301
      pathPrefixes:
        policy: Disabled

    # Redirect to different domain
    - matches:
        - path: /blog
          type: PathPrefix
          priority: 1700
      actions:
        - type: redirect
          redirect:
            hostname: blog.example.com
            path: ${path}
            statusCode: 302
      pathPrefixes:
        policy: Disabled

    # Redirect with path transformation using segments
    # /products/123/reviews -> /v2/items/123/feedback
    - matches:
        - path: ^/products/([0-9]+)/reviews$
          type: Regex
          priority: 1600
      actions:
        - type: redirect
          redirect:
            path: /v2/items/${path.segment.1}/feedback
            statusCode: 301
      pathPrefixes:
        policy: Disabled

    # ====================
    # URL REWRITES
    # ====================

    # Simple path rewrite: /public-blog/* -> /internal/cms/blog/*
    - matches:
        - path: /public-blog
          type: PathPrefix
      actions:
        - type: rewrite
          rewrite:
            path: /internal/cms/blog
      backendRefs:
        - name: cms
          namespace: backend
          port: 8080
      pathPrefixes:
        policy: Disabled

    # Rewrite path and hostname
    - matches:
        - path: /legacy-api
          type: PathPrefix
      actions:
        - type: rewrite
          rewrite:
            path: /v2/api
            hostname: api-internal.example.svc.cluster.local
      backendRefs:
        - name: api-v2
          namespace: backend
          port: 8080
      pathPrefixes:
        policy: Disabled

    # ====================
    # HEADER MANIPULATION
    # ====================

    # Add tracing and authentication headers
    - matches:
        - path: /api/v1
          type: PathPrefix
      actions:
        - type: header-set
          header:
            name: X-Forwarded-Host
            value: ${host}
        - type: header-set
          header:
            name: X-Real-IP
            value: ${client_ip}
        - type: header-add
          header:
            name: X-Request-ID
            value: ${request_id}
        - type: header-set
          header:
            name: X-Original-URI
            value: ${path}
        - type: header-set
          header:
            name: X-Forwarded-Proto
            value: ${scheme}
        - type: header-remove
          headerName: X-Internal-Debug
      backendRefs:
        - name: api
          namespace: backend
          port: 8080
      pathPrefixes:
        policy: Disabled

    # ====================
    # COMBINED ACTIONS
    # ====================

    # Rewrite + Headers: Internal service routing with full context
    - matches:
        - path: /checkout
          type: PathPrefix
      actions:
        - type: rewrite
          rewrite:
            path: /api/checkout
        - type: header-set
          header:
            name: X-Service-Name
            value: checkout-processor
        - type: header-set
          header:
            name: X-Original-Path
            value: ${path}
        - type: header-set
          header:
            name: X-Client-IP
            value: ${client_ip}
      backendRefs:
        - name: checkout-service
          namespace: commerce
          port: 8080
      pathPrefixes:
        policy: Disabled

    # ====================
    # INLINE {prefix} PLACEHOLDER
    # ====================
    # Use {prefix} anywhere in a Regex pattern to insert the language
    # alternation group at that position instead of at the start of the path.
    # Useful when the locale segment is not the first path component.

    # Framework data routes â€” locale appears after a dynamic buildId segment
    # With prefixes [es, fr, de] this expands to: ^/_next/data/[^/]+/(es|fr|de)/
    - matches:
        - path: ^/_next/data/[^/]+/{prefix}/
          type: Regex
      backendRefs:
        - name: web-frontend
          namespace: web
          port: 80

    # Static asset locale routes
    # With prefixes [es, fr, de] this expands to: ^/static/locales/(es|fr|de)/
    - matches:
        - path: ^/static/locales/{prefix}/
          type: Regex
      backendRefs:
        - name: cdn
          namespace: assets
          port: 8080

    # Multiple {prefix} placeholders in the same pattern
    # Expands to: ^/(es|fr|de)/data/[^/]+/(es|fr|de)/
    - matches:
        - path: ^/{prefix}/data/[^/]+/{prefix}/
          type: Regex
      backendRefs:
        - name: web-frontend
          namespace: web
          port: 80

    # ====================
    # DEFAULT FALLBACK
    # ====================

    # Catch-all with low priority
    - matches:
        - path: /
          priority: 100
      backendRefs:
        - name: default
          namespace: web
          port: 80
