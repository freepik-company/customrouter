# CustomRouter Helm Chart Values
# This chart deploys the CustomRouter operator and optionally one or more external processors

# -- Global settings
global:
  # -- Image pull secrets for all deployments
  imagePullSecrets: []
  # -- Common labels to add to all resources
  commonLabels: {}

# -- Operator (controller-manager) configuration
operator:
  # -- Enable the operator deployment
  enabled: true

  # -- Number of replicas
  replicaCount: 1

  image:
    repository: ghcr.io/freepik-company/customrouter/operator
    # -- Image tag (defaults to vX.Y.Z from Chart.appVersion if empty)
    tag: ""
    pullPolicy: IfNotPresent

  # -- Service account configuration
  serviceAccount:
    # -- Create a service account
    create: true
    # -- Annotations to add to the service account
    annotations: {}
    # -- Name of the service account (auto-generated if not set)
    name: ""

  # -- Pod security context
  podSecurityContext:
    runAsNonRoot: true
    seccompProfile:
      type: RuntimeDefault

  # -- Container security context
  securityContext:
    readOnlyRootFilesystem: true
    allowPrivilegeEscalation: false
    capabilities:
      drop:
        - ALL

  # -- Resource requests and limits
  resources:
    limits:
      cpu: 500m
      memory: 128Mi
    requests:
      cpu: 10m
      memory: 64Mi

  # -- Arguments for the manager binary
  # Add or remove flags as needed
  args:
    - --leader-elect
    - --health-probe-bind-address=:8081

  # -- Node selector
  nodeSelector: {}

  # -- Tolerations
  tolerations: []

  # -- Affinity rules
  affinity: {}

  # -- Pod annotations
  podAnnotations: {}

  # -- Pod labels
  podLabels: {}

  # -- Liveness probe configuration
  livenessProbe:
    httpGet:
      path: /healthz
      port: 8081
    initialDelaySeconds: 15
    periodSeconds: 20

  # -- Readiness probe configuration
  readinessProbe:
    httpGet:
      path: /readyz
      port: 8081
    initialDelaySeconds: 5
    periodSeconds: 10

  # -- Pod Disruption Budget configuration
  pdb:
    # -- Enable PDB
    enabled: false
    # -- Minimum number of available pods (can be number or percentage)
    minAvailable: ""
    # -- Maximum number of unavailable pods (can be number or percentage)
    maxUnavailable: 1
    # -- Unhealthy pod eviction policy (IfHealthyBudget or AlwaysAllow)
    unhealthyPodEvictionPolicy: ""

  # -- Horizontal Pod Autoscaler configuration
  hpa:
    # -- Enable HPA
    enabled: false
    # -- Minimum number of replicas
    minReplicas: 1
    # -- Maximum number of replicas
    maxReplicas: 5
    # -- Metrics for autoscaling
    metrics:
      - type: Resource
        resource:
          name: cpu
          target:
            type: Utilization
            averageUtilization: 80
    # -- Behavior for scaling (optional)
    behavior: {}
    # scaleDown:
    #   stabilizationWindowSeconds: 300
    #   policies:
    #     - type: Percent
    #       value: 10
    #       periodSeconds: 60
    # scaleUp:
    #   stabilizationWindowSeconds: 0
    #   policies:
    #     - type: Percent
    #       value: 100
    #       periodSeconds: 15

  # -- Validating webhook configuration for hostname conflict detection
  webhook:
    # -- Enable validating admission webhooks
    enabled: false
    # -- Webhook server port
    port: 9443
    # -- Failure policy for CustomHTTPRoute webhook (Fail or Ignore)
    customHTTPRouteFailurePolicy: Fail
    # -- Failure policy for HTTPRoute webhook (Fail or Ignore)
    httpRouteFailurePolicy: Ignore
    # -- CA bundle (base64-encoded) to inject into the webhook configuration.
    # Required when not using cert-manager. Generate with: cat ca.crt | base64 -w0
    caBundle: ""
    # -- Name of an existing TLS secret for webhook certificates.
    # If empty, defaults to <release>-operator-webhook-tls.
    # The secret must contain tls.crt and tls.key.
    tlsSecretName: ""
    # -- Namespace selector for webhook interception.
    # By default, excludes kube-system to avoid interfering with system operations.
    namespaceSelector:
      matchExpressions:
        - key: kubernetes.io/metadata.name
          operator: NotIn
          values:
            - kube-system
    # -- cert-manager integration for webhook TLS certificates
    certManager:
      # -- Enable cert-manager Certificate resource and automatic CA injection
      enabled: false
      # -- Issuer name for the Certificate
      issuerName: ""
      # -- Issuer kind (Issuer or ClusterIssuer)
      issuerKind: ClusterIssuer

# -- External processors configuration
# You can define multiple external processors with different configurations
externalProcessors:
  # -- Default external processor
  default:
    # -- Enable this external processor
    enabled: true

    # -- Number of replicas
    replicaCount: 1

    image:
      repository: ghcr.io/freepik-company/customrouter/external-processor
      # -- Image tag (defaults to vX.Y.Z from Chart.appVersion if empty)
      tag: ""
      pullPolicy: IfNotPresent

    # -- Service account configuration
    serviceAccount:
      # -- Create a service account
      create: true
      # -- Annotations to add to the service account
      annotations: {}
      # -- Name of the service account (auto-generated if not set)
      name: ""

    # -- Arguments for the external processor binary
    # Add or remove flags as needed
    args:
      - --debug=false
      - --addr=:9001
      - --target-name=default
      - --routes-configmap-namespace=default
      - --access-log=true
      - --grpc-max-recv-msg-size=4194304
      - --grpc-max-send-msg-size=4194304
      - --grpc-max-concurrent-streams=1000
      - --grpc-keepalive-time=30s
      - --grpc-keepalive-timeout=10s
      - --grpc-max-connection-idle=5m
      - --grpc-max-connection-age=30m
      - --grpc-max-connection-age-grace=10s

    # -- Service configuration
    service:
      type: ClusterIP
      port: 9001

    # -- Pod security context
    podSecurityContext: {}

    # -- Container security context
    securityContext: {}

    # -- Resource requests and limits
    resources:
      limits:
        cpu: 500m
        memory: 128Mi
      requests:
        cpu: 100m
        memory: 64Mi

    # -- Node selector
    nodeSelector: {}

    # -- Tolerations
    tolerations: []

    # -- Affinity rules
    affinity: {}

    # -- Pod annotations
    podAnnotations: {}

    # -- Pod labels
    podLabels: {}

    # -- Liveness probe configuration
    livenessProbe:
      grpc:
        port: 9001
      initialDelaySeconds: 5
      periodSeconds: 10

    # -- Readiness probe configuration
    readinessProbe:
      grpc:
        port: 9001
      initialDelaySeconds: 5
      periodSeconds: 5

    # -- Pod Disruption Budget configuration
    pdb:
      # -- Enable PDB
      enabled: false
      # -- Minimum number of available pods (can be number or percentage)
      minAvailable: ""
      # -- Maximum number of unavailable pods (can be number or percentage)
      maxUnavailable: 1
      # -- Unhealthy pod eviction policy (IfHealthyBudget or AlwaysAllow)
      unhealthyPodEvictionPolicy: ""

    # -- Horizontal Pod Autoscaler configuration
    hpa:
      # -- Enable HPA
      enabled: false
      # -- Minimum number of replicas
      minReplicas: 1
      # -- Maximum number of replicas
      maxReplicas: 10
      # -- Metrics for autoscaling
      metrics:
        - type: Resource
          resource:
            name: cpu
            target:
              type: Utilization
              averageUtilization: 80
      # -- Behavior for scaling (optional)
      behavior: {}
      # scaleDown:
      #   stabilizationWindowSeconds: 300
      #   policies:
      #     - type: Percent
      #       value: 10
      #       periodSeconds: 60
      # scaleUp:
      #   stabilizationWindowSeconds: 0
      #   policies:
      #     - type: Percent
      #       value: 100
      #       periodSeconds: 15

# -- Install CRDs
crds:
  # -- Install CustomHTTPRoute and ExternalProcessorAttachment CRDs
  install: true

# -- Extra objects to deploy (raw manifests)
# Useful for deploying CustomHTTPRoute, ExternalProcessorAttachment, or any other resources
extraObjects: []
# - apiVersion: customrouter.freepik.com/v1alpha1
#   kind: CustomHTTPRoute
#   metadata:
#     name: my-routes
#   spec:
#     targetRef:
#       name: default
#     hostnames:
#       - example.com
#     rules:
#       - matches:
#           - path: /
#         backendRefs:
#           - name: my-service
#             namespace: default
#             port: 80
